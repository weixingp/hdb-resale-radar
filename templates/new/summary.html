{% extends "new/components/base.html" %}
{% load static %}

{% block extrahead %}
    <script src="{% static "js/chart.min.js" %}"></script>
    <script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot"></script>
    <style>
        svg {
            cursor: pointer;
            overflow: visible;
            width: 60px;
        }
        svg #heart {
            transform-origin: center;
            animation: animateHeartOut 0.3s linear forwards;
        }
        svg #main-circ {
            transform-origin: 29.5px 29.5px;
        }

        #checkbox {
            display: none;
        }

        #checkbox:checked + label svg #heart {
            transform: scale(0.2);
            fill: #E2264D;
            animation: animateHeart 0.3s linear forwards 0.25s;
        }
        #checkbox:checked + label svg #main-circ {
            transition: all 2s;
            animation: animateCircle 0.3s linear forwards;
            opacity: 1;
        }
        #checkbox:checked + label svg #grp1 {
            opacity: 1;
            transition: 0.1s all 0.3s;
        }
        #checkbox:checked + label svg #grp1 #oval1 {
            transform: scale(0) translate(0, -30px);
            transform-origin: 0 0 0;
            transition: 0.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp1 #oval2 {
            transform: scale(0) translate(10px, -50px);
            transform-origin: 0 0 0;
            transition: 1.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp2 {
            opacity: 1;
            transition: 0.1s all 0.3s;
        }
        #checkbox:checked + label svg #grp2 #oval1 {
            transform: scale(0) translate(30px, -15px);
            transform-origin: 0 0 0;
            transition: 0.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp2 #oval2 {
            transform: scale(0) translate(60px, -15px);
            transform-origin: 0 0 0;
            transition: 1.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp3 {
            opacity: 1;
            transition: 0.1s all 0.3s;
        }
        #checkbox:checked + label svg #grp3 #oval1 {
            transform: scale(0) translate(30px, 0px);
            transform-origin: 0 0 0;
            transition: 0.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp3 #oval2 {
            transform: scale(0) translate(60px, 10px);
            transform-origin: 0 0 0;
            transition: 1.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp4 {
            opacity: 1;
            transition: 0.1s all 0.3s;
        }
        #checkbox:checked + label svg #grp4 #oval1 {
            transform: scale(0) translate(30px, 15px);
            transform-origin: 0 0 0;
            transition: 0.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp4 #oval2 {
            transform: scale(0) translate(40px, 50px);
            transform-origin: 0 0 0;
            transition: 1.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp5 {
            opacity: 1;
            transition: 0.1s all 0.3s;
        }
        #checkbox:checked + label svg #grp5 #oval1 {
            transform: scale(0) translate(-10px, 20px);
            transform-origin: 0 0 0;
            transition: 0.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp5 #oval2 {
            transform: scale(0) translate(-60px, 30px);
            transform-origin: 0 0 0;
            transition: 1.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp6 {
            opacity: 1;
            transition: 0.1s all 0.3s;
        }
        #checkbox:checked + label svg #grp6 #oval1 {
            transform: scale(0) translate(-30px, 0px);
            transform-origin: 0 0 0;
            transition: 0.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp6 #oval2 {
            transform: scale(0) translate(-60px, -5px);
            transform-origin: 0 0 0;
            transition: 1.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp7 {
            opacity: 1;
            transition: 0.1s all 0.3s;
        }
        #checkbox:checked + label svg #grp7 #oval1 {
            transform: scale(0) translate(-30px, -15px);
            transform-origin: 0 0 0;
            transition: 0.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp7 #oval2 {
            transform: scale(0) translate(-55px, -30px);
            transform-origin: 0 0 0;
            transition: 1.5s transform 0.3s;
        }
        #checkbox:checked + label svg #grp2 {
            opacity: 1;
            transition: 0.1s opacity 0.3s;
        }
        #checkbox:checked + label svg #grp3 {
            opacity: 1;
            transition: 0.1s opacity 0.3s;
        }
        #checkbox:checked + label svg #grp4 {
            opacity: 1;
            transition: 0.1s opacity 0.3s;
        }
        #checkbox:checked + label svg #grp5 {
            opacity: 1;
            transition: 0.1s opacity 0.3s;
        }
        #checkbox:checked + label svg #grp6 {
            opacity: 1;
            transition: 0.1s opacity 0.3s;
        }
        #checkbox:checked + label svg #grp7 {
            opacity: 1;
            transition: 0.1s opacity 0.3s;
        }

        @keyframes animateCircle {
            40% {
                transform: scale(10);
                opacity: 1;
                fill: #DD4688;
            }
            55% {
                transform: scale(11);
                opacity: 1;
                fill: #D46ABF;
            }
            65% {
                transform: scale(12);
                opacity: 1;
                fill: #CC8EF5;
            }
            75% {
                transform: scale(13);
                opacity: 1;
                fill: transparent;
                stroke: #CC8EF5;
                stroke-width: 0.5;
            }
            85% {
                transform: scale(17);
                opacity: 1;
                fill: transparent;
                stroke: #CC8EF5;
                stroke-width: 0.2;
            }
            95% {
                transform: scale(18);
                opacity: 1;
                fill: transparent;
                stroke: #CC8EF5;
                stroke-width: 0.1;
            }
            100% {
                transform: scale(19);
                opacity: 1;
                fill: transparent;
                stroke: #CC8EF5;
                stroke-width: 0;
            }
        }
        @keyframes animateHeart {
            0% {
                transform: scale(0.2);
            }
            40% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        @keyframes animateHeartOut {
            0% {
                transform: scale(1.4);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>
{% endblock %}

{% block body %}
    {% include "new/components/loader.html" %}

    {% include "new/components/header.html" %}

    <div class="section is_sm feautures has_style1 pt-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-10 text-center">
                    <div class="d-flex justify-content-between" style="position: relative">
                        <div class="section_head">
                            <!-- Heading -->
                            <h2 class="section_title is-center">
                                {{ town.name }}
                            </h2>
                            <h6 class="text-uppercase text-primary mb-10">
                                Resale price ranked #{{ rank }} out of {{ total_towns }}
                            </h6>
                        </div>
                        {% if user.is_authenticated %}
                            <div id="fav-btn" style="position: absolute; right: 0; min-width: 85px">
                                {% include 'new/components/fav-btn.html' %}
                                <small style="position: relative; bottom: 10px; " id="fav-text">Favourite</small>
                                {% csrf_token %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="text-left ml-4">
                        <h4>Summary</h4>
                        <hr>
                    </div>
                    <div id="container" class="mt-3" style="width: 100%;">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>

{% endblock %}

{% block extrascripts %}
    <script>
        function randomValues(count, min, max) {
            const delta = max - min;
            return Array.from({length: count}).map(() => Math.random() * delta + min);
        }
        function load_box_plot(town_name, data){
            const boxplotData = {
                // define label tree
                labels: data.labels,
                datasets: [{
                    label: town_name,
                    backgroundColor: 'rgba(255,0,0,0.5)',
                    borderColor: 'red',
                    borderWidth: 1,
                    outlierColor: '#999999',
                    padding: 10,
                    itemRadius: 0,
                    data: data.data
                }]
            };

            const ctx = document.getElementById("canvas").getContext("2d");
            window.myBar = new Chart(ctx, {
                type: 'boxplot',
                data: boxplotData,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: false,
                            position: "bottom",
                            text: 'Overview of historical resale prices in ' + town_name
                        },
                        legend: {
                            display: false,
                            position: 'top',
                        },
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: false,
                                text: 'Flat Type'
                            },
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price ( Thousands )'
                            },
                        }
                    }
                }
            });
        }
    </script>
    <script>
        $.ajax({
            url: '/api/hdb-stats',
            type: 'GET',
            data: {tid : {{ town.id }}},
            dataType: 'json',
            success: function(data) {
                load_box_plot(data['town_name'], data["boxplot"])
            },
            error: function (err) {

            }
        })

        {% if user.is_authenticated %}
            let $favCheckBox = $("#checkbox");
            $favCheckBox.change(function (){
                let is_checked = this.checked;
                $.ajax({
                    url: '/api/update-fav-town',
                    type: 'POST',
                    data: {
                        csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val(),
                        town_id: {{ town.id }},
                        is_unfav: !is_checked,
                    },
                    dataType: 'json',
                    success: function(data) {
                        if (is_checked){
                            $("#fav-text").text("Unfavourite");
                        } else {
                            $("#fav-text").text("Favourite");
                        }
                    },
                    error: function (err) {
                        alert("Unable to add/remove from favourite, please try again later");
                    }
                })
            });
            {% if is_fav %}
                $favCheckBox.prop('checked', true);
                $("#fav-text").text("Unfavourite");
            {% endif %}
        {% endif %}


    </script>
{% endblock %}